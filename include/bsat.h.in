/*============================================================================*
 * libbsat: timeout management utilities for projects that use libev.
 * Copyright (C) 2021  Andrew T. Canaday

 * This file is part of libbsat.

 * libbsat is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * libbsat is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with libbsat.  If not, see <https://www.gnu.org/licenses/>.
 *----------------------------------------------------------------------------*/

#ifndef BSAT_H
#define BSAT_H

#include "ev.h"

#ifdef __cplusplus
//extern "C" {
#endif /* __cplusplus */

/** # API Ref: libbsat */

/*--------------------------------------------------
 * Library info:
 *--------------------------------------------------*/

/** ## Library Info */

/** Release version as a 32-bit unsigned integer */
#define BSAT_VERSION @BSAT_VERSION@


#define BSAT_MAJOR (BSAT_VERSION >> 24 & 0xff)
#define BSAT_MINOR (BSAT_VERSION >> 16 & 0xff)
#define BSAT_PATCH (BSAT_VERSION >>  8 & 0xff)

/** Release version as a string. */
extern const char* BSAT_VERSION_STR;


/*--------------------------------------------------
 * Types:
 *--------------------------------------------------*/

/** ## Types */

/** ### bsat_toq_t
 *
 * Timeout queue — a set of items sharing a common timeout DELTA.
 *
 * > **NOTE**: this structure has a `void* data` member which you can set
 * > _after_ `bsat_toq_init` in order to associate program data with a given
 * > timeout queue in a way that is accessible during the callback invocation.
 */
typedef struct bsat_toq bsat_toq_t;


/** ### bsat_timeout_t
 *
 * An individual item in a timeout set
 *
 * > **NOTE**: this structure has a `void* data` member which you can set
 * > _after_ `bsat_timeout_init` in order to associate program data with a given
 * > timeout in a way that is accessible during the callback invocation.
 */
typedef struct bsat_timeout bsat_timeout_t;


/** ### bsat_callback_t
 *
 * Callback type used when an individual item in a set times out.
 *
 * > **NOTE**: once the callback has been invoked for a given item, it _will not
 * > be invoked again, unless you call `bsat_timeout_reset` to reintroduce the
 * > item into the timeout set._
 */
typedef void (*bsat_callback_t)(bsat_toq_t* toq, bsat_timeout_t* item);


struct bsat_toq {
    bsat_callback_t cb;
    bsat_timeout_t* head;
    bsat_timeout_t* tail;
    void* data;

    EV_P;
    ev_timer timer;
    ev_tstamp after;
};


struct bsat_timeout {
    bsat_timeout_t* prev;
    bsat_timeout_t* next;
    ev_tstamp tstamp;
    void* data;
};


/*--------------------------------------------------
 * BSAT Timeout Queue Functions:
 *--------------------------------------------------*/
/** ## Timeout Queue Functions */

/** ### bsat_toq_init
 *
 * Initialize a timeout queue.
 *
 * - `loop` (if EV_MULTIPLICITY is set) libev loop
 * - `cb` the callback invoked when the timeout fires
 * - `after` the timeout period, in seconds (ev-style)
 * - `data` optional user data to associate with this timeout queue
 *
 * Returns a new `bsat_toq_t*` on success; `NULL` (with `errno` set) on failure.
 */
void bsat_toq_init(EV_P_ bsat_toq_t* toq, bsat_callback_t cb, ev_tstamp after);


/** ### bsat_toq_stop
 *
 * Stop a timeout queue.
 *
 * > **NOTE**: Active items remain in the queue after stop _with their original
 * > deadlines intact!_
 */
void bsat_toq_stop(bsat_toq_t* toq);


/*--------------------------------------------------
 * BSAT Timeout Functions:
 *--------------------------------------------------*/
/** ## Timeout Functions */


/** ### bsat_timeout_init
 *
 * Initialize a timeout item.
 */
void bsat_timeout_init(bsat_timeout_t* item);


/** ### bsat_timeout_start
 *
 * Start a timeout item. Absent any calls to `bsat_timeout_reset` in the
 * interim, this means that the `bsat_callback_t` registered with `toq`
 * will be invoked for this timeout in `ev_now()` + `after` seconds.
 *
 * (See `bsat_toq_init` for details)
 */
void bsat_timeout_start(bsat_toq_t* toq, bsat_timeout_t* item);


/** ### bsat_timeout_reset
 *
 * Reset a timeout — i.e. it didn't time out, so restart the counter as if it
 * had been started right `ev_now()`.
 */
void bsat_timeout_reset(bsat_toq_t* toq, bsat_timeout_t* item);


/** ### bsat_timeout_stop
 *
 * Cancel a timeout item — i.e. unschedule it for execution.
 *
 * > **NOTE**: after invoking `bsat_timeout_stop`, the given `toq` no longer
 * > keeps track of the timeout item until it's reset.
 */
void bsat_timeout_stop(bsat_toq_t* toq, bsat_timeout_t* item);


/** ### bsat_timeout_is_active
 *
 * Returns 1 if the timeout is active; 0 otherwise.
 *
 * > **NOTE**: You usually _don't need to worry about this_; it's completely
 * > safe to stop a stopped timeout or start a started timeout — both operations
 * > are no-ops.
 */
int bsat_timeout_is_active(bsat_timeout_t* item);


#ifdef __cpluplus
//}
#endif /* __cplusplus */


#endif /* BSAT_H */
